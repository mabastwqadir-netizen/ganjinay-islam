<!DOCTYPE html>
<html lang="ckb">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ڤیدیۆ - گەنجینەی ئیسلام</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../css/style.css">
    <link rel="apple-touch-icon" href="../assets/logo.png">
    <link rel="manifest" href="../manifest.json">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="ڤیدیۆ - گەنجینەی ئیسلام">
    <meta property="og:description" content="کۆمەڵێک ڤیدیۆی بەسوود و کاریگەر.">
    <meta property="og:image" content="../assets/icons/Icon512.png">
</head>
<body>
    <script>
        if (localStorage.getItem('sidebarOpen') === 'true') {
            document.body.classList.add('sidebar-open');
        }
    </script>
    <!-- ==================== HEADER ==================== -->
    <header>
        <div class="header-container">
            <button id="sidebarToggle"><i class="fas fa-bars-staggered"></i> بەشەکان</button>
            <div class="logo"><i class="fa-sharp-duotone fa-solid fa-kaaba"></i> گەنجینەی ئیسلام</div>
            <nav id="navMenu">
                <div class="nav-scroll-wrapper">
                    <ul>
                        <li><a href="../index.html">سەرەتا</a></li>
                        <li><a href="../islam-what/index.html">ئیسلام چییە؟</a></li>
                        <li><a href="../aqidah/index.html">عەقیدە</a></li>
                        <li><a href="../tawheed/index.html">تەوحید</a></li>
                        <li><a href="../quran/index.html">قوڕئان</a></li>
                        <li><a href="../hadiths/index.html">فەرموودە</a></li>
                        <li><a href="../prayer/index.html">نوێژ</a></li>
                        <li><a href="../biography/index.html">ژیاننامەی پەیامبەر ﷺ</a></li>
                        <li><a href="../companions/index.html">هاوەڵان</a></li>
                        <li><a href="../dhikr/index.html">یادی خودا ( زیکرەکان )</a></li>
                        <li><a href="index.html" class="active">ڤیدیۆ</a></li>
                        <li><a href="../library-media/index.html">کتێبخانە</a></li>
                        <li><a href="../faq/index.html">پرسیار و وەڵام</a></li>
                    </ul>
                </div>
            </nav>
        </div>
    </header>

    <!-- ==================== MAIN CONTENT ==================== -->
    <main class="quran-content-page">
        <div class="quran-header">
            <h2><i class="fa-solid fa-clapperboard"></i> بەشی ڤیدیۆ</h2>
            <p>کۆمەڵێک ڤیدیۆی بەسوود و کاریگەر کە پێکهاتووە لە ووتار و ڕووقیەی شەرعی و قوڕئان.</p>
        </div>

        <!-- Controls (Search + Dropdown) -->
        <div class="video-controls">
            <div class="hadith-search-container">
                <input type="text" id="searchInput" class="hadith-search-input" placeholder="گەڕان لە ڤیدیۆکان...">
                <i class="fas fa-search hadith-search-icon"></i>
            </div>
            
            <div class="custom-select-wrapper">
                <select id="categorySelect" class="video-category-select" onchange="filterVideos(this.value)" aria-label="پاڵاوتنی ڤیدیۆکان بەپێی بەش">
                    <option value="all">هەموو بەشەکان</option>
                </select>
                <i class="fas fa-chevron-down select-icon"></i>
            </div>
        </div>

        <div id="video-grid" class="video-grid">
            <!-- Skeleton loaders -->
            <div class="skeleton-card video-skeleton"></div>
            <div class="skeleton-card video-skeleton"></div>
            <div class="skeleton-card video-skeleton"></div>
        </div>

        <div class="visitor-count">
            <p><i class="fas fa-eye"></i> ژمارەی سەردانیکەران: <span id="visitor-count">0</span></p>
        </div>

        <!-- Video Modal -->
        <div id="video-modal" class="book-modal-overlay">
            <div class="video-modal-content">
                <button class="book-modal-close" onclick="closeVideoModal()" title="داخستن" aria-label="داخستن"><i class="fas fa-times"></i></button>
                <div id="video-modal-body"></div>
            </div>
        </div>
    </main>

    <!-- ==================== FOOTER ==================== -->
    <footer>
        <p class="copyright">&copy; 2026 هەموو مافەکان پارێزراوە بۆ گەنجینەی ئیسلام.</p>
        
        <div class="footer-socials">
            <!-- لینکی فەیسبووک -->
            <a href="https://www.facebook.com/share/1ZrBaxzyfp/" target="_blank" rel="noopener noreferrer" class="social-btn facebook" title="Facebook">
                <i class="fab fa-facebook-f"></i>
            </a>
            
            <!-- لینکی ئینستاگرام -->
            <a href="https://www.instagram.com/mabast.w?igsh=MWx4ZHk1a2pncjBrcA==" target="_blank" rel="noopener noreferrer" class="social-btn instagram" title="Instagram">
                <i class="fab fa-instagram"></i>
            </a>
            
            <!-- لینکی یوتوب -->
            <a href="https://youtube.com/@mabast.1491?si=ZtEd5wFa2hPEpiiQ" target="_blank" rel="noopener noreferrer" class="social-btn youtube" title="YouTube">
                <i class="fab fa-youtube"></i>
            </a>
            
            <!-- ئیمەیڵ (Gmail) -->
            <a href="mailto:mabastw.qadir@gmail.com" class="social-btn email" title="Email">
                <i class="fas fa-envelope"></i>
            </a>
        </div>

        <p class="developer">گەشەپێدەر / مەبەست وریا خەیلانی</p>
    </footer>

    <script src="../js/script.js"></script>

    <!-- Supabase Integration -->
    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

        const supabaseUrl = 'https://sftnwbgwbxkmuackksho.supabase.co'
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNmdG53Ymd3YnhrbXVhY2trc2hvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc5NTIxNTAsImV4cCI6MjA4MzUyODE1MH0.ArdAj5hPfNskzYDHitg5W6y9MGNkMFwAIwG9ep0MpBw'
        const supabase = createClient(supabaseUrl, supabaseKey)

        let allVideos = [];

        let videoPagination;

        async function initVisitorCount() {
            const countEl = document.getElementById('visitor-count');
            if (!countEl) return;
            try {
                const { data, error } = await supabase.rpc('increment_global_visitor_count');
                if (error) throw error;
                countEl.innerText = data;
                await supabase.rpc('increment_page_view', { p_page_name: 'video' });
            } catch (err) { console.error('Error updating visitor count:', err); }
        }

        function getYouTubeVideoId(url) {
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
            const match = url.match(regExp);
            return (match && match[2].length === 11) ? match[2] : null;
        }

        // Make getYouTubeVideoId global so playVideo can use it
        window.getYouTubeVideoId = getYouTubeVideoId;

        // Modal Functions
        window.openVideoModal = (video) => {
            const modal = document.getElementById('video-modal');
            const modalBody = document.getElementById('video-modal-body');
            
            let playerHtml = '';
            if (video.video_type === 'youtube') {
                const videoId = getYouTubeVideoId(video.video_url);
                playerHtml = `<iframe src="https://www.youtube.com/embed/${videoId}?autoplay=1" allow="autoplay; encrypted-media" allowfullscreen style="width:100%; height:100%; border:none;"></iframe>`;
            } else if (video.video_type === 'self_hosted') {
                playerHtml = `<video src="${video.video_url}" controls autoplay style="width:100%; height:100%;"></video>`;
            }

            modalBody.innerHTML = `
                <div class="video-modal-player">${playerHtml}</div>
                <div class="video-modal-info">
                    <h3 style="color:#edcd17; font-size:1.4rem; margin-bottom:0.5rem;">${video.title}</h3>
                    <p style="color:#cbd5e1; margin-bottom:1.5rem;">${video.description || ''}</p>
                    <div style="display:flex; justify-content:flex-end;">
                         <button class="video-share-btn" onclick="shareContent('${video.title.replace(/'/g, "\\'")}', 'سەیری ئەم ڤیدیۆیە بکە', '${window.location.origin}${window.location.pathname}?video=${video.id}')">
                            <i class="fas fa-share-alt"></i> بڵاوکردنەوە
                        </button>
                    </div>
                </div>
            `;
            modal.classList.add('active');
        }

        window.closeVideoModal = () => {
            const modal = document.getElementById('video-modal');
            const modalBody = document.getElementById('video-modal-body');
            modal.classList.remove('active');
            modalBody.innerHTML = ''; // Stop video playback
            
            // Clean URL
            const url = new URL(window.location);
            url.searchParams.delete('video');
            window.history.replaceState({}, '', url);
        }

        // Close on outside click
        document.getElementById('video-modal').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) closeVideoModal();
        });

        function renderCategories() {
            const selectElement = document.getElementById('categorySelect');
            // Get unique categories from videos
            const categories = [...new Set(allVideos.map(v => v.category).filter(c => c))];
            
            // Keep the first option (All) and append others
            let optionsHTML = '<option value="all">هەموو بەشەکان</option>';
            optionsHTML += categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
            
            selectElement.innerHTML = optionsHTML;
        }

        window.filterVideos = (category) => {
            const searchInput = document.getElementById('searchInput');
            const term = searchInput.value.toLowerCase();
            if (videoPagination) {
                videoPagination.filter({ term, category });
            }
        }

        window.stopAllVideos = function() {
            const playingContainers = document.querySelectorAll('.video-embed-container[data-played="true"]');
            playingContainers.forEach(container => {
                container.dataset.played = 'false';
                const thumb = container.dataset.thumbnail;
                const title = container.dataset.title;
                
                container.innerHTML = `
                    <img src="${thumb}" alt="${title}" class="thumbnail">
                    <i class="fas fa-play-circle play-button"></i>
                `;
            });
        }

        window.playVideo = async (container, videoId, videoType, videoUrl) => {
            if (container.dataset.played === 'true') return;
            
            stopAllVideos();
            
            container.dataset.played = 'true';

            // Increment view count
            try {
                const { data: newCount, error: rpcError } = await supabase.rpc('increment_video_view', { video_id_to_update: videoId });
                if (rpcError) throw rpcError;
                const viewCountEl = document.getElementById(`view-count-${videoId}`);
                if(viewCountEl) viewCountEl.innerText = newCount;
            } catch (err) {
                console.error('Error incrementing view count:', err);
            }

            // Replace thumbnail with video player
            container.innerHTML = ''; 
            if (videoType === 'youtube') {
                const realVideoId = getYouTubeVideoId(videoUrl);
                const iframe = document.createElement('iframe');
                iframe.src = `https://www.youtube.com/embed/${realVideoId}?autoplay=1&rel=0`;
                iframe.allow = "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture";
                iframe.allowFullscreen = true;
                container.appendChild(iframe);
            } else if (videoType === 'self_hosted') {
                const videoPlayer = document.createElement('video');
                videoPlayer.src = videoUrl;
                videoPlayer.controls = true;
                videoPlayer.autoplay = true;
                container.appendChild(videoPlayer);
            }
        }

        function renderVideos(data) {
            // Check for shared video ID
            const urlParams = new URLSearchParams(window.location.search);
            const sharedVideoId = urlParams.get('video');

            if (data) {
                allVideos = data || [];
                
                renderCategories();
                
                if (!videoPagination) {
                    videoPagination = window.initPagination({
                        containerId: 'video-grid',
                        itemsPerPage: 6,
                        renderItem: (video) => {
                            let videoId = null;
                            if (video.video_type === 'youtube') {
                                videoId = getYouTubeVideoId(video.video_url);
                            }
                            const thumbnailUrl = video.thumbnail_url || (videoId ? `https://img.youtube.com/vi/${videoId}/hqdefault.jpg` : '../assets/images/video-placeholder.jpg');

                            const itemId = `video_${video.id}`;

                            return `
                                <div class="video-card" data-video-id="${video.id}">
                                    ${window.getNewBadge(video.created_at, itemId)}
                                    <div class="video-embed-container" 
                                         data-thumbnail="${thumbnailUrl}" 
                                         data-title="${video.title}"
                                         data-played="false"
                                         onclick="playVideo(this, '${video.id}', '${video.video_type}', '${video.video_url}'); window.markItemAsViewed('${itemId}')">
                                        <img src="${thumbnailUrl}" alt="${video.title}" class="thumbnail">
                                        <i class="fas fa-play-circle play-button"></i>
                                    </div>
                                    <div class="video-info">
                                        <h3 class="video-title">${video.title}</h3>
                                        <p class="video-description">${video.description || ''}</p>
                                        <div class="video-meta">
                                            <div class="views">
                                                <i class="fas fa-eye"></i>
                                                <span class="view-count" id="view-count-${video.id}">${video.views}</span> بینین
                                            </div>
                                            <button class="video-share-btn" onclick="event.stopPropagation(); shareContent('${video.title.replace(/'/g, "\\'")}', 'سەیری ئەم ڤیدیۆیە بکە', '${window.location.origin}${window.location.pathname}?video=${video.id}')" title="بڵاوکردنەوە">
                                                <i class="fas fa-share-alt"></i> بڵاوکردنەوە
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `;
                        },
                        filterItem: (video, queryObj) => {
                            const { term, category } = queryObj;
                            const matchesSearch = video.title.toLowerCase().includes(term) || (video.description && video.description.toLowerCase().includes(term));
                            const matchesCategory = category === 'all' || video.category === category;
                            return matchesSearch && matchesCategory;
                        }
                    });
                }
                videoPagination.init(allVideos);

                // Open modal if shared video exists
                if (sharedVideoId) {
                    const sharedVideo = allVideos.find(v => v.id == sharedVideoId);
                    if (sharedVideo) {
                        setTimeout(() => window.openVideoModal(sharedVideo), 500);
                    }
                }

                // Enable Search
                const searchInput = document.getElementById('searchInput');
                searchInput.addEventListener('input', (e) => {
                    const term = e.target.value.toLowerCase();
                    const categorySelect = document.getElementById('categorySelect');
                    const category = categorySelect.value;
                    
                    if (videoPagination) {
                        videoPagination.filter({ term, category });
                    }
                });
            } else {
                document.getElementById('video-grid').innerHTML = '<p class="empty-message grid-full-width">هیچ ڤیدیۆیەک نەدۆزرایەوە.</p>';
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            initVisitorCount();
            window.fetchAndCacheData('videos', renderVideos, supabase, 'display_order', true);
        });
    </script>
</body>
</html>